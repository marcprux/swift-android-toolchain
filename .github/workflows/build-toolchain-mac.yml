name: Swift Android Build Matrix

on:
  workflow_dispatch:
  push:
    branches:
      - '*'
  pull_request_target:
    branches:
      - '*'
  schedule:
    - cron: '30 8 * * *'

jobs:
  build:
    name: Android NDK ${{ matrix.ndk }} Swift ${{ matrix.swift }}
    timeout-minutes: 600

    strategy:
      matrix:
        xcode: ['13.3.1', '14.0.1']
        #xcode: ['13.3.1']

        swift: ['5.5.2', '5.5.3', '5.6.3', '5.7'] 

        ndk: ['r21e', 'r22b']
        # need to extract from .dmg for more recent NDK versions
        #ndk: ['r21e', 'r22b', 'r25b']

        include:
          - ndk: 'r21e'
            ndkversion: '21.4.7075529'
            ndkurl: 'https://dl.google.com/android/repository/android-ndk-r21e-darwin-x86_64.zip'
          - ndk: 'r22b'
            ndkversion: '22.1.7171670'
            ndkurl: 'https://dl.google.com/android/repository/android-ndk-r22b-darwin-x86_64.zip'
          #- ndk: 'r23c'
            #ndkversion: '23.2.8568313'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r23c-darwin.dmg'
          #- ndk: 'r24'
            #ndkversion: '24.0.8215888'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r24-darwin.dmg'
          #- ndk: 'r25b'
            #ndkversion: '25.1.8937393'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r25b-darwin.dmg'
 
          # get tags by updating with swift-android-build.sh
          # grep ' [a-z]*: "' lib/Git/Revision.js

          - swift: '5.5.2'
            # https://github.com/apple/swift/releases/tag/swift-5.5.2-RELEASE
            #tag-swift:      '4c45f525dc315a618868caae7d976d95359700a4'
            #tag-dispatch:   '5cc1c6679822fd18368664482a5bba57270467f4'
            #tag-foundation: '491a217baa8a0ef4ae9c8603c434c069cc090c50'
            #tag-llvm:       'c315411fac10439aa7a09dce976b5716af9f149c'
            #tag-cmark:      '9c8096a23f44794bde297452d87c455fc4f76d42'
            #tag-spm:        '7a1f113534689c77b3a4110288478580b7b8d91c'
            #tag-llb:        '83c4bcb8dfca48cc065325287b55d08ff7b26428'
            #tag-tsc:        '3b586ce12865db205081acdcea79fe5509b28152'
            #tag-sd:         '86c54dacd270e0c43374c0cb9b2ceb2924c9ea72'
            #tag-sap:        '986d191f94cec88f6350056da59c2e59e83d1229'
            #tag-yams:       '9ff1cc9327586db4e0c8f46f064b6a82ec1566fa'
            #tag-sc:         '0141f53dd525706c803b0c20aa8ad36f9ecd45e5'
            #tag-ssl:        '894da2fb7ed5d314ee5c2fc9fd2d9b8b74111596'
            #tag-icu:        'e2d85306162d3a0691b070b4f0a73e4012433444'
            #tag-curl:       '566b74a0e19b9aa610f4931e5bfd339bcf8e9147'
            #tag-xml:        'f8a8c1f59db355b46962577e7b74f1a1e8149dc6'
            #tag-cblas:      'b89fb708caa5a5a32de8f4306c4ff132e0228e9'

          - swift: '5.5.3'
            # https://github.com/apple/swift/releases/tag/swift-5.5.3-RELEASE
            #tag-swift:      '79f723e49c485ad5d1ccbb6aeee98b9c9118dd22'
            #tag-dispatch:   '5cc1c6679822fd18368664482a5bba57270467f4'
            #tag-foundation: 'ffeb0f8af03165488ab2b818cd49d943922687a3'
            #tag-llvm:       'e560cdd64bd089f8c27d7f8e353f78bb6e53017f'
            #tag-cmark:      '9c8096a23f44794bde297452d87c455fc4f76d42'
            #tag-spm:        'a29154a4137747bdbfe83ca26db4b24f8c4fcd31'
            #tag-llb:        '83c4bcb8dfca48cc065325287b55d08ff7b26428'
            #tag-tsc:        '3b586ce12865db205081acdcea79fe5509b28152'
            #tag-sd:         '86c54dacd270e0c43374c0cb9b2ceb2924c9ea72'
            #tag-sap:        '986d191f94cec88f6350056da59c2e59e83d1229'
            #tag-yams:       '9ff1cc9327586db4e0c8f46f064b6a82ec1566fa'
            #tag-sc:         '0141f53dd525706c803b0c20aa8ad36f9ecd45e5'
            #tag-ssl:        '894da2fb7ed5d314ee5c2fc9fd2d9b8b74111596'
            #tag-icu:        'e2d85306162d3a0691b070b4f0a73e4012433444'
            #tag-curl:       '566b74a0e19b9aa610f4931e5bfd339bcf8e9147'
            #tag-xml:        'f8a8c1f59db355b46962577e7b74f1a1e8149dc6'
            #tag-cblas:      'b89fb708caa5a5a32de8f4306c4ff132e0228e9a'

          - swift: '5.6.3'
            # https://github.com/apple/swift/releases/tag/swift-5.6.3-RELEASE
            #tag-cblas:      'b89fb708caa5a5a32de8f4306c4ff132e0228e9a'
            #tag-swift:      '4c45f525dc315a618868caae7d976d95359700a4'
            #tag-dispatch:   '5cc1c6679822fd18368664482a5bba57270467f4'
            #tag-foundation: '491a217baa8a0ef4ae9c8603c434c069cc090c50'
            #tag-llvm:       'c315411fac10439aa7a09dce976b5716af9f149c'
            #tag-cmark:      '9c8096a23f44794bde297452d87c455fc4f76d42'
            #tag-spm:        '7a1f113534689c77b3a4110288478580b7b8d91c'
            #tag-llb:        '83c4bcb8dfca48cc065325287b55d08ff7b26428'
            #tag-tsc:        '3b586ce12865db205081acdcea79fe5509b28152'
            #tag-sd:         '86c54dacd270e0c43374c0cb9b2ceb2924c9ea72'
            #tag-sap:        '986d191f94cec88f6350056da59c2e59e83d1229'
            #tag-yams:       '9ff1cc9327586db4e0c8f46f064b6a82ec1566fa'
            #tag-sc:         '0141f53dd525706c803b0c20aa8ad36f9ecd45e5'
            #tag-ssl:        '894da2fb7ed5d314ee5c2fc9fd2d9b8b74111596'
            #tag-icu:        'e2d85306162d3a0691b070b4f0a73e4012433444'
            #tag-curl:       '566b74a0e19b9aa610f4931e5bfd339bcf8e9147'
            #tag-xml:        'f8a8c1f59db355b46962577e7b74f1a1e8149dc6'
            #tag-cblas:      'b89fb708caa5a5a32de8f4306c4ff132e0228e9a'

          - swift: '5.7'
            # https://github.com/apple/swift/releases/tag/swift-5.7-RELEASE
            #tag-swift:      '4c45f525dc315a618868caae7d976d95359700a4'
            #tag-dispatch:   '5cc1c6679822fd18368664482a5bba57270467f4'
            #tag-foundation: '491a217baa8a0ef4ae9c8603c434c069cc090c50'
            #tag-llvm:       'c315411fac10439aa7a09dce976b5716af9f149c'
            #tag-cmark:      '9c8096a23f44794bde297452d87c455fc4f76d42'
            #tag-spm:        '7a1f113534689c77b3a4110288478580b7b8d91c'
            #tag-llb:        '83c4bcb8dfca48cc065325287b55d08ff7b26428'
            #tag-tsc:        '3b586ce12865db205081acdcea79fe5509b28152'
            #tag-sd:         '86c54dacd270e0c43374c0cb9b2ceb2924c9ea72'
            #tag-sap:        '986d191f94cec88f6350056da59c2e59e83d1229'
            #tag-yams:       '9ff1cc9327586db4e0c8f46f064b6a82ec1566fa'
            #tag-sc:         '0141f53dd525706c803b0c20aa8ad36f9ecd45e5'
            #tag-ssl:        '894da2fb7ed5d314ee5c2fc9fd2d9b8b74111596'
            #tag-icu:        'e2d85306162d3a0691b070b4f0a73e4012433444'
            #tag-curl:       '566b74a0e19b9aa610f4931e5bfd339bcf8e9147'
            #tag-xml:        'f8a8c1f59db355b46962577e7b74f1a1e8149dc6'
            #tag-cblas:      'b89fb708caa5a5a32de8f4306c4ff132e0228e9a'


    runs-on: macOS-12
    env:
      NDK_VERSION: ${{ matrix.ndkversion }}

    concurrency:
      group: ${{ matrix.ndk }}-${{ matrix.swift }}-${{ matrix.xcode }}-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true

    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}

      - uses: actions/checkout@master

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ matrix.ndk }}

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja autoconf automake libtool pkg-config git-lfs curl gfortran android-platform-tools

      - name: Setup NDK
        run: |
          echo ${{ matrix.ndkversion }} > NDK_VERSION

          curl -O -fsSL ${{ matrix.ndkurl }}
          # TODO: handle .dmg (which is how recent NDK versions are packaged)
          # e.g.: 
          # hdiutil attach -plist -nobrowse -readonly -mountrandom /tmp/droid android-ndk-r25b-darwin.dmg
          # cp -a /tmp/droid/dmg.IfDPvM/AndroidNDK8937393.app/Contents/NDK ./${{ matrix.ndkversion }}
          unzip -qq $(basename ${{ matrix.ndkurl }}) -d ./${{ matrix.ndkversion }}

          sudo mkdir -p /usr/local/ndk
          sudo ln -vsif ${GITHUB_WORKSPACE}/${{ matrix.ndkversion }}/android-ndk-${{ matrix.ndk }} /usr/local/ndk/${{ matrix.ndkversion }} 

          echo $(ls /usr/local/ndk/${{ matrix.ndkversion }})
          echo $(ls /Users/runner/Library/Android/sdk/ndk/)
          echo $(ls /Users/runner/Library/Android/sdk/ndk/${{ matrix.ndkversion }})

      - name: Cache Toolchain
        uses: ./.github/actions/cache-always
        with:
          key: swift-android-toolchain-cache-swift-${{ matrix.swift }}-ndk-${{ matrix.ndk }}
          path: |
            ./ToolChain

      - name: Check before build
        run: |
          which cmake
          which ninja
          which autoconf
          which aclocal
          which glibtool
          which pkg-config
          which git-lfs
          xcode-select --print-path

      - name: Setup Swift ${{ matrix.swift }}
        run: |
          sed -I "" 's; swift: ".*",; swift: ${{ matrix.tag-swift }},;g' lib/Git/Revision.js
          sed -I "" 's; dispatch: ".*",; dispatch: ${{ matrix.tag-dispatch }},;g' lib/Git/Revision.js
          sed -I "" 's; foundation: ".*",; foundation: ${{ matrix.tag-foundation }},;g' lib/Git/Revision.js
          sed -I "" 's; llvm: ".*",; llvm: ${{ matrix.tag-llvm }},;g' lib/Git/Revision.js
          sed -I "" 's; cmark: ".*",; cmark: ${{ matrix.tag-cmark }},;g' lib/Git/Revision.js
          sed -I "" 's; spm: ".*",; spm: ${{ matrix.tag-spm }},;g' lib/Git/Revision.js
          sed -I "" 's; llb: ".*",; llb: ${{ matrix.tag-llb }},;g' lib/Git/Revision.js
          sed -I "" 's; tsc: ".*",; tsc: ${{ matrix.tag-tsc }},;g' lib/Git/Revision.js
          sed -I "" 's; sd: ".*",; sd: ${{ matrix.tag-sd }},;g' lib/Git/Revision.js

      - name: Build
        run: |
          node main.js bootstrap

      - name: Check Swift Version
        # e.g.: Swift version 5.5.2 (swift-5.5.2-RELEASE) Target: x86_64-apple-darwin21.6.0
        run: |
          ./ToolChain/swift-android-toolchain/usr/bin/swift --version
          mv ./ToolChain/swift-android-toolchain.tar.gz ./ToolChain/swift-${{ matrix.swift }}-android-ndk-${{matrix.ndk }}-xcode-${{ matrix.xcode }}-toolchain.tar.gz

      - name: Upload Archive
        uses: actions/upload-artifact@v3
        with:
          #name: Toolchain build archive
          #path: ./ToolChain/swift-android-toolchain.tar.gz
          path: ./ToolChain/swift-${{ matrix.swift }}-android-ndk-${{matrix.ndk }}-xcode-${{ matrix.xcode }}-toolchain.tar.gz

      # Create a new release for this tag
      - name: "Create Release"
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating release: ${GITHUB_REF#refs/tags/}"
          # create a pre-release if it doesn't already exist 
          gh release create "${GITHUB_REF#refs/tags/}" --prerelease --title "Release ${GITHUB_REF#refs/tags/}" --generate-notes || true
          gh release upload "${GITHUB_REF#refs/tags/}" -- ./ToolChain/swift-${{ matrix.swift }}-android-ndk-${{matrix.ndk }}-xcode-${{ matrix.xcode }}-toolchain.tar.gz

