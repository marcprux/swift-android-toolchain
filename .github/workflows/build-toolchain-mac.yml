name: Build toochain for Android

on: [push, release, workflow_dispatch]


jobs:
  build:
    name: Swift ${{ matrix.swift }} toolchain NDK ${{ matrix.ndk }}
    timeout-minutes: 600

    strategy:
      matrix:
        #xcode: ['13.3.1', '14.0.1']
        xcode: ['13.3.1']
        #swift: ['5.5', '5.6', '5.7']
        swift: ['5.5']
        #ndk: ['r21e', 'r22b', 'r25b']
        ndk: ['r21e', 'r22b']
        include:
          - ndk: 'r21e'
            ndkversion: '21.4.7075529'
            ndkurl: 'https://dl.google.com/android/repository/android-ndk-r21e-darwin-x86_64.zip'
          - ndk: 'r22b'
            ndkversion: '22.1.7171670'
            ndkurl: 'https://dl.google.com/android/repository/android-ndk-r22b-darwin-x86_64.zip'
          #- ndk: 'r23c'
            #ndkversion: '23.2.8568313'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r23c-darwin.dmg'
          #- ndk: 'r24'
            #ndkversion: '24.0.8215888'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r24-darwin.dmg'
          #- ndk: 'r25b'
            #ndkversion: '25.1.8937393'
            #ndkurl: 'https://dl.google.com/android/repository/android-ndk-r25b-darwin.dmg'

    runs-on: macOS-12
    concurrency:
      #group: ${{ github.ref_name }}
      cancel-in-progress: true

    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}

      - uses: actions/checkout@master

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ matrix.ndk }}

      - name: Cache Homebrew
        uses: ./.github/actions/cache-always
        with:
          key: swift-android-homebrew-cache
          path: |
            /usr/local/Homebrew

      - name: Download dependencies
        run: |
          brew update
          brew install cmake ninja autoconf automake libtool pkg-config git-lfs curl gfortran android-platform-tools

      - name: Setup NDK
        run: |
          curl -O -fsSL ${{ matrix.ndkurl }}
          # TODO: handle .dmg (which is how recent NDK versions are packaged)
          unzip -qq $(basename ${{ matrix.ndkurl }}) -d ./${{ matrix.ndkversion }}

          sudo mkdir -p /usr/local/ndk
          sudo ln -vsif ${GITHUB_WORKSPACE}/${{ matrix.ndkversion }}/android-ndk-${{ matrix.ndk }} /usr/local/ndk/${{ matrix.ndkversion }} 

          echo $(ls /usr/local/ndk/${{ matrix.ndkversion }})
          echo $(ls /Users/runner/Library/Android/sdk/ndk/)
          echo $(ls /Users/runner/Library/Android/sdk/ndk/${{ matrix.ndkversion }})

      - name: Cache Toolchain
        uses: ./.github/actions/cache-always
        with:
          key: swift-android-toolchain-cache
          path: |
            ./ToolChain

      - name: Check before build
        run: |
          which cmake
          which ninja
          which autoconf
          which aclocal
          which glibtool
          which pkg-config
          which git-lfs
          xcode-select --print-path
      - name: Build
        run: |
          node main.js bootstrap

      - name: Archiving
        uses: actions/upload-artifact@v3
        with:
          name: Toolchain build archive
          path: ./ToolChain/swift-android-toolchain.tar.gz

